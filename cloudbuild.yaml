steps:
  # -----------------------------------------------------------------------------
  # Step 0: Gradle Ï∫êÏãú Î≥µÏõê
  # -----------------------------------------------------------------------------
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Restore Cache'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gsutil cp gs://${_PRIVATE_BUCKET}/cache/gradle_cache.tar.gz /tmp/cache.tar.gz || echo "No cache found"
        if [ -f /tmp/cache.tar.gz ]; then
          tar -xzf /tmp/cache.tar.gz -C /root/
          echo "‚úÖ Cache restored."
        fi

  # -----------------------------------------------------------------------------
  # Step 1: config.json ÏÉùÏÑ±
  # -----------------------------------------------------------------------------
  - name: 'ubuntu'
    id: 'Create Config'
    env:
      - 'PROJECT_ID=${_PROJECT_ID}'
      - 'APP_NAME=${_APP_NAME}'
      - 'PACKAGE_NAME=${_PACKAGE_NAME}'
      - 'LOADING_URL=${_LOADING_URL}'
      - 'VERSION_NAME=${_VERSION_NAME}'
      - 'VERSION_CODE=${_VERSION_CODE}'
    script: |
      echo "üîç Validating inputs..."
      
      if [ -z "$PROJECT_ID" ]; then echo "‚ùå Error: PROJECT_ID missing"; exit 1; fi
      
      cat <<EOF > app/config.json
      {
        "projectId": "$PROJECT_ID",
        "appName": "$APP_NAME",
        "packageName": "$PACKAGE_NAME",
        "loadingUrl": "$LOADING_URL",
        "appVersionName": "$VERSION_NAME",
        "appVersionCode": $VERSION_CODE
      }
      EOF
      
      if [ ! -s app/config.json ]; then echo "‚ùå Error: config failed"; exit 1; fi
      cat app/config.json

  # -----------------------------------------------------------------------------
  # Step 2: Ïï± ÏïÑÏù¥ÏΩò Îã§Ïö¥Î°úÎìú (Ìè¨Îß∑ ÏûêÎèô Í∞êÏßÄ Î∞è ÌôïÏû•Ïûê ÏûêÎèô Ìï†Îãπ)
  # -----------------------------------------------------------------------------
  - name: 'ubuntu'
    id: 'Download Icon'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # ÌïÑÏàò Ìå®ÌÇ§ÏßÄ ÏÑ§Ïπò (curl, file)
        apt-get update && apt-get install -y curl file
        
        if [ -z "${_APP_ICON_URL}" ]; then echo "‚ùå Error: _APP_ICON_URL missing"; exit 1; fi
        
        # ÎîîÎ†âÌÜ†Î¶¨ ÏÉùÏÑ± (Ï†àÎåÄ Í≤ΩÎ°ú)
        ICON_DIR="/workspace/app/src/main/res/mipmap-xxxhdpi"
        mkdir -p "$$ICON_DIR"
        
        echo "‚¨áÔ∏è Downloading icon..."
        # ÏûÑÏãú ÌååÏùºÎ°ú Îã§Ïö¥Î°úÎìú
        if ! curl -L -o /tmp/temp_icon "${_APP_ICON_URL}"; then
           echo "‚ùå Error: Download failed"
           exit 1
        fi
        
        # ÌååÏùº ÌÉÄÏûÖ ÌôïÏù∏ (MIME Type Í∞êÏßÄ)
        FILE_TYPE=$(file --mime-type -b /tmp/temp_icon)
        echo "‚ÑπÔ∏è Detected file type: $$FILE_TYPE"
        
        # ÌÉÄÏûÖÏóê Îî∞Î•∏ ÌôïÏû•Ïûê Í≤∞Ï†ï
        EXT="png" # Í∏∞Î≥∏Í∞í
        if [[ "$$FILE_TYPE" == "image/jpeg" ]]; then EXT="jpg"; fi
        if [[ "$$FILE_TYPE" == "image/png" ]]; then EXT="png"; fi
        if [[ "$$FILE_TYPE" == "image/webp" ]]; then EXT="webp"; fi
        
        echo "‚ÑπÔ∏è Using extension: .$$EXT"
        
        # Í∏∞Ï°¥ ÏïÑÏù¥ÏΩò ÌååÏùº Î™®Îëê ÏÇ≠Ï†ú (Ï§ëÎ≥µ Î∞©ÏßÄ)
        rm -f "$$ICON_DIR"/ic_launcher.*
        
        # Ïò¨Î∞îÎ•∏ ÌôïÏû•ÏûêÎ°ú Î≥µÏÇ¨
        cp /tmp/temp_icon "$$ICON_DIR/ic_launcher.$$EXT"
        cp /tmp/temp_icon "$$ICON_DIR/ic_launcher_round.$$EXT"
        
        # (ÏÑ†ÌÉù) ÎßåÏïΩ round Ïù¥ÎØ∏ÏßÄÍ∞Ä Î≥ÑÎèÑÎ°ú ÌïÑÏöîÌïòÎã§Î©¥ Ïó¨Í∏∞ÏÑú Ï≤òÎ¶¨
        
        echo "‚úÖ Icon saved as ic_launcher.$$EXT"

  # -----------------------------------------------------------------------------
  # Step 3: ÏÑúÎ™Ö ÌÇ§ ÌôïÏù∏
  # -----------------------------------------------------------------------------
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Check/Download Keystore'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        KEY_SECRET_ID="keystore-${_PROJECT_ID}"
        echo "üîê Checking: $$KEY_SECRET_ID"
        
        if gcloud secrets versions access latest --secret="$$KEY_SECRET_ID" --out-file="app/keystore.jks"; then
          echo "‚úÖ Keystore found."
        else
          echo "‚ö†Ô∏è Keystore not found. Will create."
          touch create_new_keystore 
        fi

  # -----------------------------------------------------------------------------
  # Step 4: ÏÑúÎ™Ö ÌÇ§ ÏÉùÏÑ±
  # -----------------------------------------------------------------------------
  - name: 'asia-northeast3-docker.pkg.dev/appbox-479702/appbox-artifact-registry/android-builder:latest'
    id: 'Generate Keystore'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ -f create_new_keystore ]; then
          echo "üÜï Generating keystore..."
          SALT="mobpa_secret_salt_v1"
          RAW_HASH=$(echo -n "${_PROJECT_ID}$$SALT" | sha256sum)
          ALIAS="key_$(echo -n $$RAW_HASH | cut -c1-10)"
          PASS="$(echo -n $$RAW_HASH | cut -c11-26)A1!"
        
          if ! keytool -genkeypair -v \
            -keystore app/keystore.jks \
            -alias "$$ALIAS" \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass "$$PASS" \
            -keypass "$$PASS" \
            -dname "CN=${_APP_NAME}, OU=AppBox, O=MobPa, L=Seoul, C=KR"; then
             echo "‚ùå Error: keytool failed"
             exit 1
          fi
        
          echo "$$ALIAS" > keystore_alias
          echo "$$PASS" > keystore_pass
          echo "‚úÖ Keystore generated."
        fi

  # -----------------------------------------------------------------------------
  # Step 5: ÏÑúÎ™Ö ÌÇ§ ÏóÖÎ°úÎìú
  # -----------------------------------------------------------------------------
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Upload Keystore Secret'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ -f create_new_keystore ]; then
          KEY_SECRET_ID="keystore-${_PROJECT_ID}"
          echo "üì§ Uploading to Secret Manager..."
          gcloud secrets create "$$KEY_SECRET_ID" --replication-policy="automatic" || true
          if ! gcloud secrets versions add "$$KEY_SECRET_ID" --data-file="app/keystore.jks"; then
             echo "‚ö†Ô∏è Warning: Failed to upload key."
          else
             echo "‚úÖ Keystore uploaded."
          fi
        fi

  # -----------------------------------------------------------------------------
  # Step 6: ÏÇ¨Ï†Ñ ÎπåÎìú Ï†êÍ≤Ä (ÌôïÏû•Ïûê Î¨¥Í¥ÄÌïòÍ≤å ÌôïÏù∏)
  # -----------------------------------------------------------------------------
  - name: 'ubuntu'
    id: 'Pre-Build Check'
    script: |
      echo "üîç Checking files in /workspace/app/..."
      
      if [ ! -s /workspace/app/config.json ]; then echo "‚ùå Error: app/config.json missing!"; exit 1; fi
      
      # [ÏàòÏ†ï] ÌôïÏû•ÏûêÍ∞Ä jpg, png, webp Î¨¥ÏóáÏù¥Îì† 'ic_launcher'Î°ú ÏãúÏûëÌïòÎäî ÌååÏùºÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
      ICON_COUNT=$(ls /workspace/app/src/main/res/mipmap-xxxhdpi/ic_launcher.* 2>/dev/null | wc -l)
      
      if [ "$ICON_COUNT" -eq "0" ]; then 
          echo "‚ùå Error: Icon missing at /workspace/app/src/main/res/mipmap-xxxhdpi/"
          exit 1; 
      fi
      
      if [ ! -s /workspace/app/keystore.jks ]; then echo "‚ùå Error: Keystore missing!"; exit 1; fi
      
      echo "‚úÖ All files present."

  # -----------------------------------------------------------------------------
  # Step 7: Gradle ÏÑ§Ï†ïÏóê ÏÑúÎ™Ö Ï†ïÎ≥¥ Ï£ºÏûÖ
  # -----------------------------------------------------------------------------
  - name: 'ubuntu'
    id: 'Inject Signing Config'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üíâ Injecting signing config..."
        GRADLE_FILE="app/build.gradle.kts"
        
        if [ ! -f "$$GRADLE_FILE" ]; then echo "‚ùå Error: $$GRADLE_FILE missing"; exit 1; fi

        if [ -f create_new_keystore ]; then
          ALIAS=$(cat keystore_alias)
          PASS=$(cat keystore_pass)
        else
          SALT="mobpa_secret_salt_v1"
          RAW_HASH=$(echo -n "${_PROJECT_ID}$$SALT" | sha256sum)
          ALIAS="key_$(echo -n $$RAW_HASH | cut -c1-10)"
          PASS="$(echo -n $$RAW_HASH | cut -c11-26)A1!"
        fi
        
        sed -i "s|__KEYSTORE_PATH__|keystore.jks|g" $$GRADLE_FILE
        sed -i "s|__KEYSTORE_STORE_PASSWORD__|$$PASS|g" $$GRADLE_FILE
        sed -i "s|__KEY_ALIAS__|$$ALIAS|g" $$GRADLE_FILE
        sed -i "s|__KEY_PASSWORD__|$$PASS|g" $$GRADLE_FILE
        
        echo "‚úÖ Config injected."

  # -----------------------------------------------------------------------------
  # Step 8: ÏÜåÏä§ Î∞±ÏóÖ
  # -----------------------------------------------------------------------------
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Archive Source'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üì¶ Archiving source..."
        tar -czf /tmp/source_backup.tar.gz --exclude=.git --exclude=.gradle --exclude=app/build \
          --exclude=create_new_keystore --exclude=keystore_alias --exclude=keystore_pass .
        
        TARGET_PATH="gs://${_PRIVATE_BUCKET}/${_PROJECT_ID}/${_VERSION_NAME}/source/"
        echo "üì§ Uploading to: $$TARGET_PATH"
        gsutil cp /tmp/source_backup.tar.gz "$$TARGET_PATH"

  # -----------------------------------------------------------------------------
  # Step 9: Android ÎπåÎìú
  # -----------------------------------------------------------------------------
  - name: 'asia-northeast3-docker.pkg.dev/appbox-479702/appbox-artifact-registry/android-builder:latest'
    id: 'Build Artifacts'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        chmod +x gradlew
        ./gradlew assembleRelease bundleRelease --build-cache

  # -----------------------------------------------------------------------------
  # Step 10: Ï∫êÏãú Ï†ÄÏû•
  # -----------------------------------------------------------------------------
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Save Cache'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üíæ Saving cache..."
        tar -czf /tmp/cache.tar.gz -C /root/ .gradle
        gsutil cp /tmp/cache.tar.gz gs://${_PRIVATE_BUCKET}/cache/gradle_cache.tar.gz
        echo "‚úÖ Cache saved."

  # -----------------------------------------------------------------------------
  # Step 11: Í≤∞Í≥ºÎ¨º ÏóÖÎ°úÎìú
  # -----------------------------------------------------------------------------
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Upload Artifacts'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üöÄ Uploading artifacts..."
        BASE_PATH="gs://${_PUBLIC_BUCKET}/${_PROJECT_ID}/${_VERSION_NAME}"
        APK_PATH="$$BASE_PATH/apk/"
        AAB_PATH="$$BASE_PATH/aab/"
        
        gsutil cp app/build/outputs/apk/release/*.apk "$$APK_PATH"
        gsutil cp app/build/outputs/bundle/release/*.aab "$$AAB_PATH"

substitutions:
  _PROJECT_ID: ""
  _APP_NAME: ""
  _PACKAGE_NAME: ""
  _LOADING_URL: ""
  _VERSION_NAME: "1.0.1"
  _VERSION_CODE: "1"
  _APP_ICON_URL: ""
  _PUBLIC_BUCKET: "appbox-public-assets"
  _PRIVATE_BUCKET: "appbox-build-artifacts"

timeout: 3600s

options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY