steps:
  # ==================================================================
  # Step 0: Gradle ìºì‹œ ë¶ˆëŸ¬ì˜¤ê¸° (ë¹Œë“œ ì†ë„ ë‹¨ì¶•ì˜ í•µì‹¬)
  # ==================================================================
  # GCS ë²„í‚·ì˜ cache í´ë”ì—ì„œ ì´ì „ ë¹Œë“œ ì •ë³´ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
  # ì‹¤íŒ¨í•´ë„(ì²« ë¹Œë“œë¼ íŒŒì¼ì´ ì—†ì–´ë„) ì—ëŸ¬ê°€ ë‚˜ì§€ ì•Šë„ë¡ || echo ì²˜ë¦¬í•©ë‹ˆë‹¤.
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Restore Cache'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "â™»ï¸ Restoring Gradle cache..."
        gsutil cp gs://${_DEST_BUCKET}/cache/gradle_cache.tar.gz /tmp/cache.tar.gz || echo "No cache found."
        
        if [ -f /tmp/cache.tar.gz ]; then
          tar -xzf /tmp/cache.tar.gz -C /root/
          echo "âœ… Cache restored."
        fi

  # ==================================================================
  # Step 1: ì„¤ì • íŒŒì¼(config.json) ì£¼ì…
  # ==================================================================
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Inject Config'
    args: ['cp', '${_CONFIG_GCS_PATH}', 'app/config.json']

  # ==================================================================
  # Step 2: ì•± ì•„ì´ì½˜ ì£¼ì…
  # ==================================================================
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Inject Icon'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        mkdir -p app/src/main/res/mipmap-xxxhdpi
        gsutil cp ${_ICON_GCS_PATH} app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
        # ë¼ìš´ë“œ ì•„ì´ì½˜ ì²˜ë¦¬ (ë³µì‚¬)
        cp app/src/main/res/mipmap-xxxhdpi/ic_launcher.png app/src/main/res/mipmap-xxxhdpi/ic_launcher_round.png

  # ==================================================================
  # Step 3: ì•ˆë“œë¡œì´ë“œ ë¹Œë“œ (APK + AAB ìƒì„±)
  # ==================================================================
  - name: 'asia-northeast3-docker.pkg.dev/appbox-479702/appbox-artifact-registry/android-builder:latest'
    id: 'Build Artifacts'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        chmod +x gradlew
        # --build-cache: ìºì‹œ ì‚¬ìš© ì˜µì…˜
        # assembleRelease: APK ìƒì„±
        # bundleRelease: AAB ìƒì„±
        ./gradlew assembleRelease bundleRelease --build-cache

  # ==================================================================
  # Step 4: Gradle ìºì‹œ ì €ì¥ (ë‹¤ìŒ ë¹Œë“œë¥¼ ìœ„í•´)
  # ==================================================================
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Save Cache'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ’¾ Saving Gradle cache..."
        # .gradle í´ë”ë¥¼ ì••ì¶•
        tar -czf /tmp/cache.tar.gz -C /root/ .gradle
        # GCSì— ì—…ë¡œë“œ (ë®ì–´ì“°ê¸°)
        gsutil cp /tmp/cache.tar.gz gs://${_DEST_BUCKET}/cache/gradle_cache.tar.gz
        echo "âœ… Cache saved."

  # ==================================================================
  # Step 5: ê²°ê³¼ë¬¼(APK, AAB) ì—…ë¡œë“œ
  # ==================================================================
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Upload Artifacts'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸš€ Uploading artifacts..."
        # íŒŒì¼ëª…ì´ ë°”ë€Œì—ˆë”ë¼ë„ í™•ì¥ì(*.apk, *.aab)ë¡œ ëª¨ë‘ ì¡ì•„ì„œ ì—…ë¡œë“œí•©ë‹ˆë‹¤.
        gsutil cp app/build/outputs/apk/release/*.apk ${_OUTPUT_GCS_PATH}
        gsutil cp app/build/outputs/bundle/release/*.aab ${_OUTPUT_GCS_PATH}

# ë³€ìˆ˜ ì •ì˜
substitutions:
  _CONFIG_GCS_PATH: "gs://ë²„í‚·ëª…/ê²½ë¡œ/ì„¤ì •.json"
  _ICON_GCS_PATH: "gs://ë²„í‚·ëª…/ê²½ë¡œ/ì•„ì´ì½˜.png"
  _OUTPUT_GCS_PATH: "gs://ë²„í‚·ëª…/ê²°ê³¼ë¬¼í´ë”/"
  _DEST_BUCKET: "appbox-479702_cloudbuild" # ìºì‹œë¥¼ ì €ì¥í•  ë²„í‚· ì´ë¦„

options:
  machineType: 'E2_HIGHCPU_8' # ê³ ì„±ëŠ¥ ë¨¸ì‹  ì‚¬ìš© (ë¹Œë“œ ì‹œê°„ ë‹¨ì¶• í•„ìˆ˜)
  logging: CLOUD_LOGGING_ONLY
  timeout: 3600s