steps:
  # ==================================================================
  # Step 0: Gradle ìºì‹œ ë³µì› (ì†ë„ ìµœì í™”)
  # ==================================================================
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Restore Cache'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gsutil cp gs://${_DEST_BUCKET}/cache/gradle_cache.tar.gz /tmp/cache.tar.gz || echo "No cache found"
        if [ -f /tmp/cache.tar.gz ]; then
          tar -xzf /tmp/cache.tar.gz -C /root/
          echo "âœ… Cache restored."
        fi

  # ==================================================================
  # Step 1: config.json ë™ì  ìƒì„± (ìš”ì²­ ë°ì´í„° -> íŒŒì¼ ë³€í™˜)
  # ==================================================================
  # ì „ë‹¬ë°›ì€ íŒŒë¼ë¯¸í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ app/config.json íŒŒì¼ì„ ì‹¤ì œë¡œ ë§Œë“¤ì–´ëƒ…ë‹ˆë‹¤.
  - name: 'ubuntu'
    id: 'Create Config'
    script: |
      echo "Creating config.json from inputs..."
      
      # cat ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ JSON íŒŒì¼ ìƒì„±
      cat <<EOF > app/config.json
      {
        "projectId": "${_PROJECT_ID}",
        "appName": "${_APP_NAME}",
        "packageName": "${_PACKAGE_NAME}",
        "loadingUrl": "${_LOADING_URL}",
        "appVersionName": "${_VERSION_NAME}",
        "appVersionCode": ${_VERSION_CODE}
      }
      EOF
      
      # ìƒì„±ëœ ë‚´ìš© í™•ì¸ (ë¡œê·¸ìš©)
      cat app/config.json

  # ==================================================================
  # Step 2: ì•± ì•„ì´ì½˜ ë‹¤ìš´ë¡œë“œ
  # ==================================================================
  - name: 'gcr.io/cloud-builders/curl'
    id: 'Download Icon'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "Downloading icon from ${_APP_ICON_URL}..."
        mkdir -p app/src/main/res/mipmap-xxxhdpi
        
        # ì•„ì´ì½˜ ë‹¤ìš´ë¡œë“œ
        curl -L -o app/src/main/res/mipmap-xxxhdpi/ic_launcher.png "${_APP_ICON_URL}"
        
        # ë¼ìš´ë“œ ì•„ì´ì½˜ ë³µì‚¬
        cp app/src/main/res/mipmap-xxxhdpi/ic_launcher.png app/src/main/res/mipmap-xxxhdpi/ic_launcher_round.png

  # ==================================================================
  # Step 2-A: ì•± ì„œëª…í‚¤ í™•ì¸ ë° ë‹¤ìš´ë¡œë“œ
  # ==================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Check/Download Keystore'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        SECRET_ID="keystore-${_PROJECT_ID}"
        echo "ğŸ” Checking Secret Manager for: $$SECRET_ID"
        
        if gcloud secrets versions access latest --secret="$$SECRET_ID" --out-file="app/keystore.jks"; then
          echo "âœ… Keystore found and downloaded."
        else
          echo "âš ï¸ Keystore not found. Marking for creation."
          touch /tmp/create_new_keystore
        fi

  # ==================================================================
  # Step 2-B: ì•± ì„œëª…í‚¤ ìƒì„± (ì—†ëŠ” ê²½ìš°)
  # ==================================================================
  - name: 'asia-northeast3-docker.pkg.dev/appbox-479702/appbox-artifact-registry/android-builder:latest'
    id: 'Generate Keystore'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ -f /tmp/create_new_keystore ]; then
          echo "ğŸ†• Generating new keystore..."
        
          # ë³´ì•ˆ ê°•í™”: í•´ì‹±ì„ ì´ìš©í•œ ë¹„ë°€ë²ˆí˜¸ ìƒì„±
          SALT="mobpa_secret_salt_v1"
          RAW_HASH=$(echo -n "${_PROJECT_ID}${SALT}" | sha256sum)
          ALIAS="key_$(echo -n $RAW_HASH | cut -c1-10)"
          PASS="$(echo -n $RAW_HASH | cut -c11-26)A1!"
        
          echo "Generated Alias: $ALIAS"
        
          keytool -genkeypair -v \
            -keystore app/keystore.jks \
            -alias "$ALIAS" \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass "$PASS" \
            -keypass "$PASS" \
            -dname "CN=${_APP_NAME}, OU=AppBox, O=MobPa, L=Seoul, C=KR"
        
          # ë‹¤ìŒ ë‹¨ê³„ë¥¼ ìœ„í•´ ì„ì‹œ ì €ì¥
          echo "$ALIAS" > /tmp/keystore_alias
          echo "$PASS" > /tmp/keystore_pass
        
          echo "âœ… New keystore generated."
        fi

  # ==================================================================
  # Step 2-C: ìƒì„±ëœ í‚¤ Secret Manager ì—…ë¡œë“œ
  # ==================================================================
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Upload Keystore Secret'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ -f /tmp/create_new_keystore ]; then
          SECRET_ID="keystore-${_PROJECT_ID}"
          echo "ğŸ“¤ Uploading new keystore to Secret Manager..."
        
          gcloud secrets create "$$SECRET_ID" --replication-policy="automatic" || true
          gcloud secrets versions add "$$SECRET_ID" --data-file="app/keystore.jks"
        
          echo "âœ… Keystore saved to Secret Manager."
        fi

  # ==================================================================
  # Step 2-D: Gradleì— ì„œëª… ì •ë³´ ì£¼ì…
  # ==================================================================
  - name: 'ubuntu'
    id: 'Inject Signing Config'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ’‰ Injecting signing configuration..."
        GRADLE_FILE="app/build.gradle.kts"
        
        if [ -f /tmp/create_new_keystore ]; then
          ALIAS=$(cat /tmp/keystore_alias)
          PASS=$(cat /tmp/keystore_pass)
        else
          # ê¸°ì¡´ í‚¤ ë³µì› ë¡œì§ (ìƒì„± ë¡œì§ê³¼ ë™ì¼í•´ì•¼ í•¨)
          SALT="mobpa_secret_salt_v1"
          RAW_HASH=$(echo -n "${_PROJECT_ID}${SALT}" | sha256sum)
          ALIAS="key_$(echo -n $RAW_HASH | cut -c1-10)"
          PASS="$(echo -n $RAW_HASH | cut -c11-26)A1!"
        fi
        
        # build.gradle.kts ì¹˜í™˜
        sed -i "s|__KEYSTORE_PATH__|keystore.jks|g" $GRADLE_FILE
        sed -i "s|__KEYSTORE_STORE_PASSWORD__|$PASS|g" $GRADLE_FILE
        sed -i "s|__KEY_ALIAS__|$ALIAS|g" $GRADLE_FILE
        sed -i "s|__KEY_PASSWORD__|$PASS|g" $GRADLE_FILE
        
        echo "âœ… Signing config injected."

  # ==================================================================
  # Step 2-E: í”„ë¡œì íŠ¸ ì†ŒìŠ¤ ë°±ì—… (í‚¤ìŠ¤í† ì–´ í¬í•¨ë¨)
  # ==================================================================
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Archive Source'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ“¦ Archiving project source..."
        tar -czf /tmp/source_backup.tar.gz --exclude=.git --exclude=.gradle --exclude=app/build .
        
        TARGET_PATH="${_OUTPUT_GCS_PATH%/}/${_VERSION_NAME}/source/"
        echo "ğŸ“¤ Uploading source to: $TARGET_PATH"
        gsutil cp /tmp/source_backup.tar.gz "$TARGET_PATH"

  # ==================================================================
  # Step 3: ì•ˆë“œë¡œì´ë“œ ë¹Œë“œ
  # ==================================================================
  - name: 'asia-northeast3-docker.pkg.dev/appbox-479702/appbox-artifact-registry/android-builder:latest'
    id: 'Build Artifacts'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        chmod +x gradlew
        # config.jsonì´ ì´ë¯¸ Step 1ì—ì„œ ë§Œë“¤ì–´ì¡Œìœ¼ë¯€ë¡œ Gradleì€ ê·¸ê²ƒì„ ì½ìŠµë‹ˆë‹¤.
        ./gradlew assembleRelease bundleRelease --build-cache

  # ==================================================================
  # Step 4: Gradle ìºì‹œ ì €ì¥ (ë‹¤ìŒ ë¹Œë“œë¥¼ ìœ„í•´)
  # ==================================================================
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Save Cache'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ’¾ Saving Gradle cache..."
        # .gradle í´ë”ë¥¼ ì••ì¶•
        tar -czf /tmp/cache.tar.gz -C /root/ .gradle
        # GCSì— ì—…ë¡œë“œ (ë®ì–´ì“°ê¸°)
        gsutil cp /tmp/cache.tar.gz gs://${_DEST_BUCKET}/cache/gradle_cache.tar.gz
        echo "âœ… Cache saved."

  # ==================================================================
  # Step 5: ê²°ê³¼ë¬¼(APK, AAB) ì—…ë¡œë“œ
  # ==================================================================
  # [ìˆ˜ì •] apkì™€ aab í´ë”ì— ê°ê° ì €ì¥ë˜ë„ë¡ ê²½ë¡œ ë³€ê²½
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Upload Artifacts'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸš€ Uploading artifacts..."
        
        # ê²½ë¡œ ë³€ìˆ˜ ìƒì„± (ë§ˆì§€ë§‰ ìŠ¬ë˜ì‹œ ì œê±° ì²˜ë¦¬ í¬í•¨)
        BASE_PATH="${_OUTPUT_GCS_PATH%/}/${_VERSION_NAME}"
        APK_PATH="$BASE_PATH/apk/"
        AAB_PATH="$BASE_PATH/aab/"
        
        echo " - APK Path: $APK_PATH"
        echo " - AAB Path: $AAB_PATH"
        
        # APK ì—…ë¡œë“œ (í´ë” ìë™ ìƒì„±ë¨)
        gsutil cp app/build/outputs/apk/release/*.apk "$APK_PATH"
        
        # AAB ì—…ë¡œë“œ (í´ë” ìë™ ìƒì„±ë¨)
        gsutil cp app/build/outputs/bundle/release/*.aab "$AAB_PATH"

# ë³€ìˆ˜ ì •ì˜
substitutions:
  _PROJECT_ID: "AAA-000000"
  _APP_NAME: "ì•±ë°•ìŠ¤"
  _PACKAGE_NAME: "kr.co.mobpa.sample.waveAppSuiteSdk"
  _LOADING_URL: "https://www.appboxapp.com/"
  _VERSION_NAME: "1.0.1"
  _VERSION_CODE: "1"
  _APP_ICON_URL: "https://via.placeholder.com/150"
  _OUTPUT_GCS_PATH: "gs://my-bucket/output/"
  _DEST_BUCKET: "my-bucket"

timeout: 3600s

options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY