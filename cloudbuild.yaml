steps:
  # ============================================================================
  # [Î≥ëÎ†¨ Í∑∏Î£π 1] Ï§ÄÎπÑ ÏûëÏóÖ ÎèôÏãú ÏãúÏûë
  # ============================================================================

  # -----------------------------------------------------------------------------
  # Step 0: Gradle Ï∫êÏãú Î≥µÏõê Î∞è ÌÇ§ Í≥ÑÏÇ∞ (3Î≤à Ï†ÑÎûµ: Ï∫êÏãú ÌÇ§ Î°úÏßÅ Ï∂îÍ∞Ä)
  # -----------------------------------------------------------------------------
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Restore Cache'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        mkdir -p /root/.gradle

        # [3Î≤à Ï†ÑÎûµ] ÏùòÏ°¥ÏÑ± ÌååÏùºÎì§Ïùò Î≥ÄÍ≤Ω Ïó¨Î∂ÄÎ•º ÌôïÏù∏ÌïòÍ∏∞ ÏúÑÌïú Ìï¥Ïãú(Key) Í≥ÑÏÇ∞
        # build.gradle.ktsÎÇò libs.versions.tomlÏù¥ Î≥ÄÍ≤ΩÎêòÎ©¥ Ìï¥ÏãúÍ∞íÏù¥ Î∞îÎÄùÎãàÎã§.
        echo "üîë Calculating cache key..."
        cat build.gradle.kts app/build.gradle.kts gradle/libs.versions.toml | sha256sum | awk '{print $1}' > /tmp/current_cache.key
        
        # ÏõêÍ≤© Ï†ÄÏû•ÏÜåÏóê ÏûàÎäî Ïù¥Ï†Ñ Ï∫êÏãú ÌÇ§ Îã§Ïö¥Î°úÎìú (ÎπÑÍµêÏö©)
        gsutil cp "gs://${_PRIVATE_BUCKET}/${_PROJECT_ID}/cache/cache.key" /tmp/remote_cache.key || echo "no_remote_key" > /tmp/remote_cache.key

        echo "‚¨áÔ∏è Downloading cache..."
        gsutil cp gs://${_PRIVATE_BUCKET}/${_PROJECT_ID}/cache/gradle_cache.tar.gz /tmp/cache.tar.gz || echo "No cache found"
        
        if [ -f /tmp/cache.tar.gz ]; then
          tar -xzf /tmp/cache.tar.gz -C /root/
          echo "‚úÖ Cache restored."
        fi

  # -----------------------------------------------------------------------------
  # Step 1: config.json ÎèôÏ†Å ÏÉùÏÑ±
  # -----------------------------------------------------------------------------
  - name: 'ubuntu'
    id: 'Create Config'
    waitFor: ['-']
    env:
      - 'PROJECT_ID=${_PROJECT_ID}'
      - 'APP_NAME=${_APP_NAME}'
      - 'PACKAGE_NAME=${_PACKAGE_NAME}'
      - 'LOADING_URL=${_LOADING_URL}'
      - 'VERSION_NAME=${_VERSION_NAME}'
      - 'VERSION_CODE=${_VERSION_CODE}'
    script: |
      echo "üîç Validating inputs..."
      if [ -z "$PROJECT_ID" ]; then echo "‚ùå Error: PROJECT_ID missing"; exit 1; fi
      if [ -z "$APP_NAME" ]; then echo "‚ùå Error: APP_NAME missing"; exit 1; fi
      
      cat <<EOF > app/config.json
      {
        "projectId": "$PROJECT_ID",
        "appName": "$APP_NAME",
        "packageName": "$PACKAGE_NAME",
        "loadingUrl": "$LOADING_URL",
        "appVersionName": "$VERSION_NAME",
        "appVersionCode": $VERSION_CODE
      }
      EOF

  # -----------------------------------------------------------------------------
  # Step 2: Ïï± ÏïÑÏù¥ÏΩò ÏÉùÏÑ± (ÏµúÏ†ÅÌôî: Ïª§Ïä§ÌÖÄ Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö©)
  # -----------------------------------------------------------------------------
  # [ÏàòÏ†ïÎê®] ubuntu -> android-builder Ïù¥ÎØ∏ÏßÄ ÏÇ¨Ïö© (apt-get ÏÑ§Ïπò Í≥ºÏ†ï Ï†úÍ±∞)
  - name: 'asia-northeast3-docker.pkg.dev/appbox-479702/appbox-artifact-registry/android-builder:latest'
    id: 'Download & Process Icons'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # apt-get install Í≥ºÏ†ï ÏÇ≠Ï†úÎê® (Ïù¥ÎØ∏ÏßÄÏóê Ìè¨Ìï®Îê®)
        
        if [ -z "${_APP_ICON_URL}" ]; then echo "‚ùå Error: _APP_ICON_URL missing"; exit 1; fi
        
        echo "‚¨áÔ∏è Downloading icon..."
        if ! curl -f -L -o /tmp/icon_origin "${_APP_ICON_URL}"; then
           echo "‚ùå Error: Download failed"
           exit 1
        fi
        
        echo "üé® Creating Icons..."
        convert /tmp/icon_origin -resize 512x512! /tmp/icon_master.png
        
        ICONS="48:mipmap-mdpi 72:mipmap-hdpi 96:mipmap-xhdpi 144:mipmap-xxhdpi 192:mipmap-xxxhdpi"
        
        for config in $$ICONS; do
            SIZE=$${config%%:*}
            FOLDER=$${config##*:}
            TARGET_DIR="app/src/main/res/$$FOLDER"
            mkdir -p "$$TARGET_DIR"
        
            # ÏÇ¨Í∞ÅÌòï ÏïÑÏù¥ÏΩò
            convert /tmp/icon_master.png -resize "$${SIZE}x$${SIZE}!" "$$TARGET_DIR/ic_launcher.png"
        
            # ÏõêÌòï ÏïÑÏù¥ÏΩò
            CENTER=$((SIZE / 2))
            convert /tmp/icon_master.png -resize "$${SIZE}x$${SIZE}!" \
              -alpha set -gravity center \
              \( +clone -threshold -1 -negate -fill white -draw "circle $$CENTER,$$CENTER $$CENTER,0" \) \
              -alpha off -compose copy_opacity -composite \
              "$$TARGET_DIR/ic_launcher_round.png"
        done
        echo "‚úÖ Icons generated."

  # -----------------------------------------------------------------------------
  # Step 3: ÏÑúÎ™Ö ÌÇ§ ÌôïÏù∏
  # -----------------------------------------------------------------------------
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Check Keystore'
    waitFor: ['-']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        KEY_SECRET_ID="keystore-${_PROJECT_ID}"
        if gcloud secrets versions access latest --secret="$$KEY_SECRET_ID" --out-file="app/keystore.jks"; then
          echo "‚úÖ Keystore found."
        else
          echo "‚ö†Ô∏è Keystore not found. Will create."
          touch create_new_keystore 
        fi

  # ============================================================================
  # [ÏãúÌÄÄÏä§ Í∑∏Î£π] ÌÇ§Ïä§ÌÜ†Ïñ¥ ÏÉùÏÑ± Î∞è Ï£ºÏûÖ
  # ============================================================================

  # -----------------------------------------------------------------------------
  # Step 4: ÏÑúÎ™Ö ÌÇ§ ÏÉùÏÑ±
  # -----------------------------------------------------------------------------
  - name: 'asia-northeast3-docker.pkg.dev/appbox-479702/appbox-artifact-registry/android-builder:latest'
    id: 'Generate Keystore'
    waitFor: ['Check Keystore']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ -f create_new_keystore ]; then
          SALT="mobpa_secret_salt_v1"
          RAW_HASH=$(echo -n "${_PROJECT_ID}$$SALT" | sha256sum)
          ALIAS="key_$(echo -n $$RAW_HASH | cut -c1-10)"
          PASS="$(echo -n $$RAW_HASH | cut -c11-26)A1!"
        
          keytool -genkeypair -v -keystore app/keystore.jks -alias "$$ALIAS" -keyalg RSA -keysize 2048 -validity 10000 -storepass "$$PASS" -keypass "$$PASS" -dname "CN=${_APP_NAME}, OU=AppBox, O=MobPa, L=Seoul, C=KR"
          echo "$$ALIAS" > keystore_alias
          echo "$$PASS" > keystore_pass
        fi

  # -----------------------------------------------------------------------------
  # Step 5: ÏÑúÎ™Ö ÌÇ§ ÏóÖÎ°úÎìú
  # -----------------------------------------------------------------------------
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Upload Keystore'
    waitFor: ['Generate Keystore']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ -f create_new_keystore ]; then
          KEY_SECRET_ID="keystore-${_PROJECT_ID}"
          gcloud secrets create "$$KEY_SECRET_ID" --replication-policy="automatic" || true
          gcloud secrets versions add "$$KEY_SECRET_ID" --data-file="app/keystore.jks"
        fi

  # -----------------------------------------------------------------------------
  # Step 7: Gradle ÏÑ§Ï†ïÏóê ÏÑúÎ™Ö Ï†ïÎ≥¥ Ï£ºÏûÖ
  # -----------------------------------------------------------------------------
  - name: 'ubuntu'
    id: 'Inject Signing'
    waitFor: ['Upload Keystore']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        GRADLE_FILE="app/build.gradle.kts"
        if [ -f create_new_keystore ]; then
          ALIAS=$(cat keystore_alias)
          PASS=$(cat keystore_pass)
        else
          SALT="mobpa_secret_salt_v1"
          RAW_HASH=$(echo -n "${_PROJECT_ID}$$SALT" | sha256sum)
          ALIAS="key_$(echo -n $$RAW_HASH | cut -c1-10)"
          PASS="$(echo -n $$RAW_HASH | cut -c11-26)A1!"
        fi
        sed -i "s|__KEYSTORE_PATH__|keystore.jks|g" $$GRADLE_FILE
        sed -i "s|__KEYSTORE_STORE_PASSWORD__|$$PASS|g" $$GRADLE_FILE
        sed -i "s|__KEY_ALIAS__|$$ALIAS|g" $$GRADLE_FILE
        sed -i "s|__KEY_PASSWORD__|$$PASS|g" $$GRADLE_FILE

  # ============================================================================
  # [ÎèôÍ∏∞Ìôî Ìè¨Ïù∏Ìä∏] Î™®Îì† Ï§ÄÎπÑÎ¨º ÏôÑÎ£å ÌôïÏù∏
  # ============================================================================

  # -----------------------------------------------------------------------------
  # Step 6: ÏÇ¨Ï†Ñ ÎπåÎìú Ï†êÍ≤Ä
  # -----------------------------------------------------------------------------
  - name: 'ubuntu'
    id: 'Pre-Build Check'
    waitFor: ['Create Config', 'Download & Process Icons', 'Inject Signing']
    script: |
      if [ ! -s app/config.json ]; then echo "‚ùå Error: config.json missing"; exit 1; fi
      if [ $(ls app/src/main/res/mipmap-xxxhdpi/ic_launcher.* | wc -l) -eq 0 ]; then echo "‚ùå Error: Icon missing"; exit 1; fi
      if [ ! -s app/keystore.jks ]; then echo "‚ùå Error: Keystore missing"; exit 1; fi
      echo "‚úÖ Ready to build."

  # ============================================================================
  # [Î≥ëÎ†¨ Í∑∏Î£π 2] ÎπåÎìú Î∞è ÏïÑÏπ¥Ïù¥Î∏å
  # ============================================================================

  # -----------------------------------------------------------------------------
  # Step 8: ÏÜåÏä§ Î∞±ÏóÖ
  # -----------------------------------------------------------------------------
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Archive Source'
    waitFor: ['Pre-Build Check']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        tar -czf /tmp/source_backup.tar.gz --exclude=.git --exclude=.gradle --exclude=app/build \
          --exclude=create_new_keystore --exclude=keystore_alias --exclude=keystore_pass .
        
        TARGET_PATH="gs://${_PRIVATE_BUCKET}/${_PROJECT_ID}/${_VERSION_NAME}/source/"
        gsutil cp /tmp/source_backup.tar.gz "$$TARGET_PATH"

  # -----------------------------------------------------------------------------
  # Step 9: Android ÎπåÎìú (Î©îÏù∏ ÏûëÏóÖ)
  # -----------------------------------------------------------------------------
  - name: 'asia-northeast3-docker.pkg.dev/appbox-479702/appbox-artifact-registry/android-builder:latest'
    id: 'Build Artifacts'
    waitFor: ['Restore Cache', 'Pre-Build Check']
    entrypoint: 'bash'
    env:
      - 'GRADLE_USER_HOME=/root/.gradle'
    args:
      - '-c'
      - |
        chmod +x gradlew
        ./gradlew assembleRelease bundleRelease --parallel --max-workers=8 --build-cache --no-daemon

  # ============================================================================
  # [Î≥ëÎ†¨ Í∑∏Î£π 3] ÎßàÎ¨¥Î¶¨ (Ï†ÄÏû• Î∞è ÏóÖÎ°úÎìú)
  # ============================================================================

  # -----------------------------------------------------------------------------
  # Step 10: Ï∫êÏãú Ï†ÄÏû• (3Î≤à Ï†ÑÎûµ: Ï°∞Í±¥Î∂Ä ÏóÖÎ°úÎìú Ï†ÅÏö©)
  # -----------------------------------------------------------------------------
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Save Cache'
    waitFor: ['Build Artifacts']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Step 0ÏóêÏÑú ÏÉùÏÑ±Ìïú ÌÇ§ ÎπÑÍµê
        CURRENT_KEY=$(cat /tmp/current_cache.key)
        REMOTE_KEY=$(cat /tmp/remote_cache.key)

        if [ "$$CURRENT_KEY" == "$$REMOTE_KEY" ]; then
            echo "‚úÖ Dependencies unchanged. Skipping cache upload."
        else
            echo "üíæ Dependencies changed (Key: $$CURRENT_KEY). Saving new cache..."
            tar -czf /tmp/cache.tar.gz -C /root/ .gradle \
              --exclude='daemon' --exclude='wrapper/dists/*/*/some-garbage-file' --exclude='*.lock' --exclude='gc.properties'
        
            # Ï∫êÏãú ÌååÏùº ÏóÖÎ°úÎìú
            gsutil cp /tmp/cache.tar.gz gs://${_PRIVATE_BUCKET}/${_PROJECT_ID}/cache/gradle_cache.tar.gz
            # ÏÉàÎ°úÏö¥ ÌÇ§Í∞íÎèÑ Ìï®Íªò ÏóÖÎ°úÎìú
            gsutil cp /tmp/current_cache.key gs://${_PRIVATE_BUCKET}/${_PROJECT_ID}/cache/cache.key
            echo "‚úÖ New cache saved."
        fi

  # -----------------------------------------------------------------------------
  # Step 11: Í≤∞Í≥ºÎ¨º ÏóÖÎ°úÎìú
  # -----------------------------------------------------------------------------
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Upload Artifacts'
    waitFor: ['Build Artifacts']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "üöÄ Uploading artifacts..."
        BASE_PATH="gs://${_PUBLIC_BUCKET}/${_PROJECT_ID}/${_VERSION_NAME}"
        APK_PATH="$$BASE_PATH/apk/"
        AAB_PATH="$$BASE_PATH/aab/"
        
        gsutil cp app/build/outputs/apk/release/*.apk "$$APK_PATH"
        gsutil cp app/build/outputs/bundle/release/*.aab "$$AAB_PATH"

substitutions:
  _PROJECT_ID: ""
  _APP_NAME: ""
  _PACKAGE_NAME: ""
  _LOADING_URL: ""
  _VERSION_NAME: "1.0.1"
  _VERSION_CODE: "1"
  _APP_ICON_URL: ""

  _PUBLIC_BUCKET: "appbox-public-assets"
  _PRIVATE_BUCKET: "appbox-private-assets"

timeout: 3600s

options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY