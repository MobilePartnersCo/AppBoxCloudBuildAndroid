steps:
  # -----------------------------------------------------------------------------
  # Step 0: Gradle ìºì‹œ ë³µì› (ë¹Œë“œ ì†ë„ ìµœì í™”)
  # -----------------------------------------------------------------------------
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Restore Cache'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        gsutil cp gs://${_PRIVATE_BUCKET}/cache/gradle_cache.tar.gz /tmp/cache.tar.gz || echo "No cache found"
        if [ -f /tmp/cache.tar.gz ]; then
          tar -xzf /tmp/cache.tar.gz -C /root/
          echo "âœ… Cache restored."
        fi

  # -----------------------------------------------------------------------------
  # Step 1: config.json ë™ì  ìƒì„± ë° ì…ë ¥ê°’ ìœ íš¨ì„± ê²€ì‚¬
  # -----------------------------------------------------------------------------
  - name: 'ubuntu'
    id: 'Create Config'
    env:
      - 'PROJECT_ID=${_PROJECT_ID}'
      - 'APP_NAME=${_APP_NAME}'
      - 'PACKAGE_NAME=${_PACKAGE_NAME}'
      - 'LOADING_URL=${_LOADING_URL}'
      - 'VERSION_NAME=${_VERSION_NAME}'
      - 'VERSION_CODE=${_VERSION_CODE}'
    script: |
      echo "ğŸ” Validating inputs..."
      
      # í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ ê²€ì‚¬
      if [ -z "$PROJECT_ID" ]; then echo "âŒ Error: PROJECT_ID is missing!"; exit 1; fi
      if [ -z "$APP_NAME" ]; then echo "âŒ Error: APP_NAME is missing!"; exit 1; fi
      if [ -z "$PACKAGE_NAME" ]; then echo "âŒ Error: PACKAGE_NAME is missing!"; exit 1; fi
      if [ -z "$LOADING_URL" ]; then echo "âŒ Error: LOADING_URL is missing!"; exit 1; fi
      if [ -z "$VERSION_NAME" ]; then echo "âŒ Error: VERSION_NAME is missing!"; exit 1; fi
      if [ -z "$VERSION_CODE" ]; then echo "âŒ Error: VERSION_CODE is missing!"; exit 1; fi
      
      echo "âœ… All inputs are valid. Creating config.json..."
      
      # JSON íŒŒì¼ ìƒì„±
      cat <<EOF > app/config.json
      {
        "projectId": "$PROJECT_ID",
        "appName": "$APP_NAME",
        "packageName": "$PACKAGE_NAME",
        "loadingUrl": "$LOADING_URL",
        "appVersionName": "$VERSION_NAME",
        "appVersionCode": $VERSION_CODE
      }
      EOF
      
      # ìƒì„± ê²°ê³¼ í™•ì¸
      if [ ! -s app/config.json ]; then
        echo "âŒ Error: Failed to create config.json"
        exit 1
      fi
      
      cat app/config.json

  # -----------------------------------------------------------------------------
  # Step 2: ì•± ì•„ì´ì½˜ ë‹¤ìš´ë¡œë“œ
  # -----------------------------------------------------------------------------
  - name: 'gcr.io/cloud-builders/curl'
    id: 'Download Icon'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ -z "${_APP_ICON_URL}" ]; then echo "âŒ Error: _APP_ICON_URL is missing!"; exit 1; fi
        
        echo "Downloading icon from ${_APP_ICON_URL}..."
        mkdir -p app/src/main/res/mipmap-xxxhdpi
        
        # ì•„ì´ì½˜ ë‹¤ìš´ë¡œë“œ ë° ìœ íš¨ì„± ê²€ì‚¬
        if ! curl -f -L -o app/src/main/res/mipmap-xxxhdpi/ic_launcher.png "${_APP_ICON_URL}"; then
           echo "âŒ Error: Failed to download icon from ${_APP_ICON_URL}"
           exit 1
        fi
        
        if [ ! -s app/src/main/res/mipmap-xxxhdpi/ic_launcher.png ]; then
           echo "âŒ Error: Icon file is empty"
           exit 1
        fi

        # ë¼ìš´ë“œ ì•„ì´ì½˜ ë³µì‚¬
        cp app/src/main/res/mipmap-xxxhdpi/ic_launcher.png app/src/main/res/mipmap-xxxhdpi/ic_launcher_round.png
        echo "âœ… Icon setup complete."

  # -----------------------------------------------------------------------------
  # Step 3: ì•± ì„œëª…í‚¤(Keystore) í™•ì¸ ë° ë‹¤ìš´ë¡œë“œ (Secret Manager)
  # -----------------------------------------------------------------------------
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Check/Download Keystore'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        KEY_SECRET_ID="keystore-${_PROJECT_ID}"
        echo "ğŸ” Checking Secret Manager for: $$KEY_SECRET_ID"
        
        if gcloud secrets versions access latest --secret="$$KEY_SECRET_ID" --out-file="app/keystore.jks"; then
          echo "âœ… Keystore found and downloaded."
        else
          echo "âš ï¸ Keystore not found (or permission denied). Will attempt to create new one."
          touch create_new_keystore 
        fi

  # -----------------------------------------------------------------------------
  # Step 4: ì•± ì„œëª…í‚¤ ìƒì„± (ì—†ëŠ” ê²½ìš°)
  # -----------------------------------------------------------------------------
  - name: 'asia-northeast3-docker.pkg.dev/appbox-479702/appbox-artifact-registry/android-builder:latest'
    id: 'Generate Keystore'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ -f create_new_keystore ]; then
          echo "ğŸ†• Generating new keystore..."
        
          # ë¹„ë°€ë²ˆí˜¸ ìƒì„± (í•´ì‹±)
          SALT="mobpa_secret_salt_v1"
          RAW_HASH=$(echo -n "${_PROJECT_ID}$$SALT" | sha256sum)
          ALIAS="key_$(echo -n $$RAW_HASH | cut -c1-10)"
          PASS="$(echo -n $$RAW_HASH | cut -c11-26)A1!"
        
          echo "Generated Alias: $$ALIAS"
        
          if ! keytool -genkeypair -v \
            -keystore app/keystore.jks \
            -alias "$$ALIAS" \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -storepass "$$PASS" \
            -keypass "$$PASS" \
            -dname "CN=${_APP_NAME}, OU=AppBox, O=MobPa, L=Seoul, C=KR"; then
             echo "âŒ Error: Failed to generate keystore"
             exit 1
          fi
        
          # ìƒì„± ì •ë³´ ì„ì‹œ ì €ì¥
          echo "$$ALIAS" > keystore_alias
          echo "$$PASS" > keystore_pass
        
          echo "âœ… New keystore generated."
        fi

  # -----------------------------------------------------------------------------
  # Step 5: ìƒì„±ëœ ì„œëª…í‚¤ Secret Managerì— ì—…ë¡œë“œ
  # -----------------------------------------------------------------------------
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'Upload Keystore Secret'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ -f create_new_keystore ]; then
          KEY_SECRET_ID="keystore-${_PROJECT_ID}"
          echo "ğŸ“¤ Uploading new keystore to Secret Manager..."
        
          gcloud secrets create "$$KEY_SECRET_ID" --replication-policy="automatic" || true
          if ! gcloud secrets versions add "$$KEY_SECRET_ID" --data-file="app/keystore.jks"; then
             echo "âš ï¸ Warning: Failed to save keystore to Secret Manager."
          else
             echo "âœ… Keystore saved to Secret Manager."
          fi
        fi

  # -----------------------------------------------------------------------------
  # Step 6: ë¹Œë“œ í•„ìˆ˜ íŒŒì¼ ìµœì¢… ì ê²€
  # -----------------------------------------------------------------------------
  - name: 'ubuntu'
    id: 'Pre-Build Check'
    script: |
      echo "ğŸ” Verifying required files..."
      
      if [ ! -s app/config.json ]; then echo "âŒ Critical Error: app/config.json is missing!"; exit 1; fi
      if [ ! -s app/src/main/res/mipmap-xxxhdpi/ic_launcher.png ]; then echo "âŒ Critical Error: App icon is missing!"; exit 1; fi
      if [ ! -s app/keystore.jks ]; then echo "âŒ Critical Error: Keystore file is missing!"; exit 1; fi
      
      echo "âœ… All required files are present. Proceeding to build."

  # -----------------------------------------------------------------------------
  # Step 7: Gradle ì„¤ì •ì— ì„œëª… ì •ë³´ ì£¼ì…
  # -----------------------------------------------------------------------------
  - name: 'ubuntu'
    id: 'Inject Signing Config'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ’‰ Injecting signing configuration..."
        GRADLE_FILE="app/build.gradle.kts"
        
        # í‚¤ ìƒì„± ì—¬ë¶€ì— ë”°ë¼ ë¹„ë°€ë²ˆí˜¸ ì¶œì²˜ ê²°ì •
        if [ -f create_new_keystore ]; then
          ALIAS=$(cat keystore_alias)
          PASS=$(cat keystore_pass)
        else
          SALT="mobpa_secret_salt_v1"
          RAW_HASH=$(echo -n "${_PROJECT_ID}$$SALT" | sha256sum)
          ALIAS="key_$(echo -n $$RAW_HASH | cut -c1-10)"
          PASS="$(echo -n $$RAW_HASH | cut -c11-26)A1!"
        fi
        
        # Gradle íŒŒì¼ ë‚´ìš© ì¹˜í™˜
        sed -i "s|__KEYSTORE_PATH__|keystore.jks|g" $$GRADLE_FILE
        sed -i "s|__KEYSTORE_STORE_PASSWORD__|$$PASS|g" $$GRADLE_FILE
        sed -i "s|__KEY_ALIAS__|$$ALIAS|g" $$GRADLE_FILE
        sed -i "s|__KEY_PASSWORD__|$$PASS|g" $$GRADLE_FILE
        
        echo "âœ… Signing config injected."

  # -----------------------------------------------------------------------------
  # Step 8: í”„ë¡œì íŠ¸ ì†ŒìŠ¤ ë°±ì—… (ë¹„ê³µê°œ ë²„í‚·)
  # -----------------------------------------------------------------------------
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Archive Source'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ“¦ Archiving project source..."
        tar -czf /tmp/source_backup.tar.gz --exclude=.git --exclude=.gradle --exclude=app/build \
          --exclude=create_new_keystore --exclude=keystore_alias --exclude=keystore_pass .
        
        # ë°±ì—… ê²½ë¡œ: {ë¹„ê³µê°œë²„í‚·}/{í”„ë¡œì íŠ¸ID}/{ë²„ì „}/source/
        TARGET_PATH="gs://${_PRIVATE_BUCKET}/${_PROJECT_ID}/${_VERSION_NAME}/source/"
        
        echo "ğŸ“¤ Uploading source to: $$TARGET_PATH"
        gsutil cp /tmp/source_backup.tar.gz "$$TARGET_PATH"

  # -----------------------------------------------------------------------------
  # Step 9: Android ë¹Œë“œ ìˆ˜í–‰ (APK & AAB)
  # -----------------------------------------------------------------------------
  - name: 'asia-northeast3-docker.pkg.dev/appbox-479702/appbox-artifact-registry/android-builder:latest'
    id: 'Build Artifacts'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        chmod +x gradlew
        ./gradlew assembleRelease bundleRelease --build-cache

  # -----------------------------------------------------------------------------
  # Step 10: Gradle ìºì‹œ ì €ì¥
  # -----------------------------------------------------------------------------
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Save Cache'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ’¾ Saving Gradle cache..."
        tar -czf /tmp/cache.tar.gz -C /root/ .gradle
        gsutil cp /tmp/cache.tar.gz gs://${_PRIVATE_BUCKET}/cache/gradle_cache.tar.gz
        echo "âœ… Cache saved."

  # -----------------------------------------------------------------------------
  # Step 11: ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (ê³µê°œ ë²„í‚·)
  # -----------------------------------------------------------------------------
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'Upload Artifacts'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸš€ Uploading artifacts to Public Bucket..."
        
        # ì—…ë¡œë“œ ê²½ë¡œ: {ê³µê°œë²„í‚·}/{í”„ë¡œì íŠ¸ID}/{ë²„ì „}/[apk|aab]/
        BASE_PATH="gs://${_PUBLIC_BUCKET}/${_PROJECT_ID}/${_VERSION_NAME}"
        APK_PATH="$$BASE_PATH/apk/"
        AAB_PATH="$$BASE_PATH/aab/"
        
        echo " - APK Path: $$APK_PATH"
        echo " - AAB Path: $$AAB_PATH"
        
        gsutil cp app/build/outputs/apk/release/*.apk "$$APK_PATH"
        gsutil cp app/build/outputs/bundle/release/*.aab "$$AAB_PATH"

# -----------------------------------------------------------------------------
# Substitutions (ê¸°ë³¸ê°’)
# -----------------------------------------------------------------------------
substitutions:
  _PROJECT_ID: ""
  _APP_NAME: ""
  _PACKAGE_NAME: ""
  _LOADING_URL: ""
  _VERSION_NAME: "1.0.1"
  _VERSION_CODE: "1"
  _APP_ICON_URL: ""
  _PUBLIC_BUCKET: "appbox-public-assets"
  _PRIVATE_BUCKET: "appbox-private-artifacts"

# íƒ€ì„ì•„ì›ƒ (1ì‹œê°„)
timeout: 3600s

options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY