steps:
  # ============================================================================
  # [Step 0] í†µí•© í™˜ê²½ ì„¤ì • (Setup & Prepare)
  # - ë„ì»¤ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì˜¤ë²„í—¤ë“œë¥¼ ìµœì†Œí™”í•˜ê¸° ìœ„í•´ ë‹¨ì¼ ë‹¨ê³„ì—ì„œ ë³‘ë ¬ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤.
  # - ìˆ˜í–‰ ì‘ì—…: Config ìƒì„±, ì•„ì´ì½˜ ì²˜ë¦¬, í‚¤ìŠ¤í† ì–´ ì¤€ë¹„, Gradle ìºì‹œ ë³µì›
  # ============================================================================
  - name: 'asia-northeast3-docker.pkg.dev/appbox-479702/appbox-artifact-registry/android-builder:latest'
    id: 'Setup Environment'
    waitFor: ['-'] # ì¦‰ì‹œ ì‹œì‘
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸš€ Starting Setup..."
        
        # ----------------------------------------------------------------------
        # 1. [Background] app/config.json ìƒì„±
        # ----------------------------------------------------------------------
        (
            echo "ğŸ” Creating Config..."
            cat <<EOF > app/config.json
        {
          "projectId": "${_PROJECT_ID}",
          "appName": "${_APP_NAME}",
          "packageName": "${_PACKAGE_NAME}",
          "loadingUrl": "${_LOADING_URL}",
          "appVersionName": "${_VERSION_NAME}",
          "appVersionCode": ${_VERSION_CODE}
        }
        EOF
        ) &
        
        # ----------------------------------------------------------------------
        # 2. [Background] ì•± ì•„ì´ì½˜ ë‹¤ìš´ë¡œë“œ ë° ë¦¬ì‚¬ì´ì§• (ImageMagick)
        # ----------------------------------------------------------------------
        (
            if [ -n "${_APP_ICON_URL}" ]; then
                echo "â¬‡ï¸ Downloading icon..."
                mkdir -p /tmp/icons
                curl -f -L -o /tmp/icons/icon_origin "${_APP_ICON_URL}" || echo "Icon download failed"
                convert /tmp/icons/icon_origin -resize 512x512! /tmp/icons/icon_master.png
        
                ICONS="48:mipmap-mdpi 72:mipmap-hdpi 96:mipmap-xhdpi 144:mipmap-xxhdpi 192:mipmap-xxxhdpi"
                for config in $$ICONS; do
                    (
                        SIZE=$${config%%:*}
                        FOLDER=$${config##*:}
                        TARGET_DIR="app/src/main/res/$$FOLDER"
                        mkdir -p "$$TARGET_DIR"
                        convert /tmp/icons/icon_master.png -resize "$$SIZE"x"$$SIZE"! "$$TARGET_DIR/ic_launcher.png"
                    ) &
                done
                wait
                echo "âœ… Icons ready."
            fi
        ) &
        ICON_PID=$!

        # ----------------------------------------------------------------------
        # 3. [Background] í‚¤ìŠ¤í† ì–´ í™•ì¸/ìƒì„± ë° Gradle ì£¼ì…
        # ----------------------------------------------------------------------
        (
            echo "ğŸ”‘ Processing Keystore..."
            KEY_SECRET_ID="keystore-${_PROJECT_ID}"
            GRADLE_FILE="app/build.gradle.kts"
        
            # Secret Managerì—ì„œ í‚¤ í™•ì¸
            if ! gcloud secrets versions access latest --secret="$$KEY_SECRET_ID" --out-file="app/keystore.jks" 2>/dev/null; then
                echo "âš ï¸ Creating new keystore..."
                SALT="mobpa_secret_salt_v1"
                RAW_HASH=$(echo -n "${_PROJECT_ID}$$SALT" | sha256sum)
                ALIAS="key_$(echo -n $$RAW_HASH | cut -c1-10)"
                PASS="$(echo -n $$RAW_HASH | cut -c11-26)A1!"
        
                keytool -genkeypair -keystore app/keystore.jks -alias "$$ALIAS" -keyalg RSA -keysize 2048 -validity 10000 -storepass "$$PASS" -keypass "$$PASS" -dname "CN=${_APP_NAME}, OU=AppBox, O=MobPa, L=Seoul, C=KR"
                gcloud secrets create "$$KEY_SECRET_ID" --replication-policy="automatic" 2>/dev/null || true
                gcloud secrets versions add "$$KEY_SECRET_ID" --data-file="app/keystore.jks"
            else
                echo "âœ… Keystore fetched."
                SALT="mobpa_secret_salt_v1"
                RAW_HASH=$(echo -n "${_PROJECT_ID}$$SALT" | sha256sum)
                ALIAS="key_$(echo -n $$RAW_HASH | cut -c1-10)"
                PASS="$(echo -n $$RAW_HASH | cut -c11-26)A1!"
            fi
        
            # Gradle íŒŒì¼ì— í‚¤ ì •ë³´ ì£¼ì…
            sed -i "s|__KEYSTORE_PATH__|keystore.jks|g" $$GRADLE_FILE
            sed -i "s|__KEYSTORE_STORE_PASSWORD__|$$PASS|g" $$GRADLE_FILE
            sed -i "s|__KEY_ALIAS__|$$ALIAS|g" $$GRADLE_FILE
            sed -i "s|__KEY_PASSWORD__|$$PASS|g" $$GRADLE_FILE
        ) &
        KEY_PID=$!

        # ----------------------------------------------------------------------
        # 4. [Main Thread] Gradle ìºì‹œ ë³µì› (pigz ë³‘ë ¬ ì••ì¶• í•´ì œ)
        # ----------------------------------------------------------------------
        echo "ğŸ“¦ Restoring Cache..."
        mkdir -p /workspace/.gradle_cache
        
        # ìºì‹œ í‚¤ ê³„ì‚° (ë²„ì „ ê´€ë¦¬ìš©)
        cat build.gradle.kts app/build.gradle.kts gradle/libs.versions.toml | echo "cache_v3" | sha256sum | awk '{print $1}' > ./current_cache.key
        gcloud storage cp "gs://${_PRIVATE_BUCKET}/${_PROJECT_ID}/cache/cache.key" ./remote_cache.key 2>/dev/null || echo "no_remote_key" > ./remote_cache.key
        
        # ìºì‹œ ë‹¤ìš´ë¡œë“œ ë° í•´ì œ
        if gcloud storage cp "gs://${_PRIVATE_BUCKET}/${_PROJECT_ID}/cache/gradle_cache.tar.gz" /tmp/cache.tar.gz; then
             tar -I pigz -xf /tmp/cache.tar.gz -C /workspace/ || echo "âš ï¸ Cache extract failed"
             echo "âœ… Cache restored."
        else
             echo "âš ï¸ No cache found."
        fi

        # ----------------------------------------------------------------------
        # 5. ì‘ì—… ëŒ€ê¸° ë° ìœ íš¨ì„± ê²€ì‚¬
        # ----------------------------------------------------------------------
        wait $$ICON_PID
        wait $$KEY_PID
        
        if [ ! -s app/config.json ] || [ ! -s app/keystore.jks ]; then
            echo "âŒ Critical Error: Config or Keystore missing."
            exit 1
        fi
        echo "âœ… All preparations complete."

  # ============================================================================
  # [Step 1] ì†ŒìŠ¤ ì½”ë“œ ë°±ì—… (Archive Source)
  # - ë¹Œë“œ ê²°ê³¼ë¬¼ ë° ìºì‹œ í´ë”ë¥¼ ì œì™¸í•œ ìˆœìˆ˜ ì†ŒìŠ¤ì½”ë“œë§Œ ë°±ì—…í•©ë‹ˆë‹¤.
  # ============================================================================
  - name: 'asia-northeast3-docker.pkg.dev/appbox-479702/appbox-artifact-registry/android-builder:latest'
    id: 'Archive Source'
    waitFor: ['Setup Environment']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        tar -I pigz -cf /tmp/source_backup.tar.gz \
          --exclude='./.git' \
          --exclude='./.gradle' \
          --exclude='./.gradle_cache' \
          --exclude='./app/build' \
          --exclude='./build' \
          --exclude='./create_new_keystore' \
          --exclude='./keystore_alias' \
          --exclude='./keystore_pass' \
          .
        
        gcloud storage cp /tmp/source_backup.tar.gz "gs://${_PRIVATE_BUCKET}/${_PROJECT_ID}/${_VERSION_NAME}/source/"

  # ============================================================================
  # [Step 2] ì•ˆë“œë¡œì´ë“œ ë¹Œë“œ (Build Artifacts)
  # - Configuration Cache ë° Build Cacheë¥¼ í™œìš©í•˜ì—¬ ì†ë„ë¥¼ ìµœì í™”í•©ë‹ˆë‹¤.
  # ============================================================================
  - name: 'asia-northeast3-docker.pkg.dev/appbox-479702/appbox-artifact-registry/android-builder:latest'
    id: 'Build Artifacts'
    waitFor: ['Setup Environment']
    entrypoint: 'bash'
    env:
      - 'GRADLE_USER_HOME=/workspace/.gradle_cache'
    args:
      - '-c'
      - |
        chmod +x gradlew
        ./gradlew assembleRelease bundleRelease \
          -x lintVitalRelease \
          --parallel \
          --max-workers=8 \
          --build-cache \
          --configuration-cache \
          --no-daemon

  # ============================================================================
  # [Step 3] ìºì‹œ ì €ì¥ (Save Cache)
  # - ì˜ì¡´ì„± ë³€ê²½ì´ ê°ì§€ëœ ê²½ìš°ì—ë§Œ ìƒˆë¡œìš´ ìºì‹œë¥¼ ì••ì¶•í•˜ì—¬ ì—…ë¡œë“œí•©ë‹ˆë‹¤.
  # ============================================================================
  - name: 'asia-northeast3-docker.pkg.dev/appbox-479702/appbox-artifact-registry/android-builder:latest'
    id: 'Save Cache'
    waitFor: ['Build Artifacts']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        CURRENT_KEY=$(cat ./current_cache.key)
        REMOTE_KEY=$(cat ./remote_cache.key)

        if [ "$$CURRENT_KEY" == "$$REMOTE_KEY" ] && [ "$$REMOTE_KEY" != "no_remote_key" ]; then
            echo "âœ… Dependencies unchanged. Skipping cache upload."
        else
            echo "ğŸ’¾ Dependencies changed. Saving new cache..."
            if [ -d /workspace/.gradle_cache ]; then
                tar -I pigz -cf /tmp/cache.tar.gz -C /workspace/ .gradle_cache \
                  --exclude='daemon' --exclude='wrapper/dists/*/*/some-garbage-file' --exclude='*.lock' --exclude='gc.properties'
        
                gcloud storage cp /tmp/cache.tar.gz gs://${_PRIVATE_BUCKET}/${_PROJECT_ID}/cache/gradle_cache.tar.gz
                gcloud storage cp ./current_cache.key gs://${_PRIVATE_BUCKET}/${_PROJECT_ID}/cache/cache.key
                echo "âœ… New cache saved."
            fi
        fi

  # ============================================================================
  # [Step 4] ê²°ê³¼ë¬¼ ì—…ë¡œë“œ (Upload Artifacts)
  # - ìƒì„±ëœ APKì™€ AAB íŒŒì¼ì„ ìŠ¤í† ë¦¬ì§€ë¡œ ì „ì†¡í•©ë‹ˆë‹¤.
  # ============================================================================
  - name: 'asia-northeast3-docker.pkg.dev/appbox-479702/appbox-artifact-registry/android-builder:latest'
    id: 'Upload Artifacts'
    waitFor: ['Build Artifacts']
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸš€ Uploading artifacts..."
        BASE_PATH="gs://${_PUBLIC_BUCKET}/${_PROJECT_ID}/${_VERSION_NAME}"
        
        gcloud storage cp app/build/outputs/apk/release/*.apk "$$BASE_PATH/apk/"
        gcloud storage cp app/build/outputs/bundle/release/*.aab "$$BASE_PATH/aab/"

substitutions:
  _PROJECT_ID: ""
  _APP_NAME: ""
  _PACKAGE_NAME: ""
  _LOADING_URL: ""
  _VERSION_NAME: "1.0.1"
  _VERSION_CODE: "1"
  _APP_ICON_URL: ""
  _PUBLIC_BUCKET: "appbox-public-assets"
  _PRIVATE_BUCKET: "appbox-private-assets"

timeout: 3600s
options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY